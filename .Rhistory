y = "log ratio")
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value)) +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black")
ggplot(lka_q5, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value)) +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black")
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value)) +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()++
geom_line(data = res_2, aes(year, .value)) +
geom_ribbon(data = res_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_p_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "blue")+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black")
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value)) +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()+
geom_line(data = res_2, aes(year, .value)) +
geom_ribbon(data = res_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_p_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "blue")+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black")
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()+
geom_line(data = res_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "blue")+
geom_line(data = res_p_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_p_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "blue")+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black")
lka_q5 <- lka |>
filter(source != "VR")
observed_years <- lka_q5$year
years <- min(observed_years):max(observed_years)
nyears <- length(years)
stan_data <- list(y = lka_q5$logit_ratio, year_i = observed_years - years[1]+1,
T = nyears, years = years, N = length(observed_years),
mid_year = mean(years), se = lka_q5$se, P = 18)
mod5 <- stan(data = stan_data,
file = here("code/models/lab10_3.stan"),
iter = 2000)
res_5 <- mod5 %>%
gather_draws(mu[t]) %>%
median_qi() %>%
mutate(year = years[t])
res_p_5 <- mod5 %>%
gather_draws(mu_p[p]) %>%
median_qi() %>%
mutate(year = years[nyears]+p)
ggplot(lka_q5, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value)) +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black")
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()+
geom_line(data = res_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "blue")+
geom_line(data = res_p_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_p_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "blue")+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black")
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
theme_bw()+
geom_line(data = res_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
geom_line(data = res_p_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_p_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black")
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
theme_bw()+
geom_line(data = res_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
geom_line(data = res_p_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_p_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black") +
scale_y_continuous(limits = c(-5,5))
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
theme_bw()+
geom_line(data = res_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
geom_line(data = res_p_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_p_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black") +
scale_y_continuous(limits = c(-4.5,4.5))
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
theme_bw()+
geom_line(data = res_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
geom_line(data = res_p_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_p_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black")
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
theme_bw()+
geom_line(data = res_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
geom_line(data = res_p_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_p_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black") +
scale_y_continuous(limits = c(-5,5))
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
theme_bw()+
geom_line(data = res_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
geom_line(data = res_p_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_p_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black") +
scale_y_continuous(limits = c(-2.5,2.5))
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
theme_bw()+
geom_line(data = res_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
geom_line(data = res_p_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_p_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black") +
coord_cartesian(ylim = c(-2.5, 2.5))
ggplot(lka, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "red")+
theme_bw()+
geom_line(data = res_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
geom_line(data = res_p_2, aes(year, .value), col = "blue") +
geom_ribbon(data = res_p_2, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.15, fill = "blue")+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black")
lka_q6 <- lka |>
filter(source == "VR")
observed_years <- lka_q6$year
years <- min(observed_years):max(observed_years)
nyears <- length(years)
stan_data <- list(y = lka_q6$logit_ratio, year_i = observed_years - years[1]+1,
T = nyears, years = years, N = length(observed_years),
mid_year = mean(years), se = lka_q6$se, P = 9)
mod6 <- stan(data = stan_data,
file = here("code/models/lab10_3.stan"),
iter = 2000)
res_6 <- mod6 %>%
gather_draws(mu[t]) %>%
median_qi() %>%
mutate(year = years[t])
res_p_6 <- mod6 %>%
gather_draws(mu_p[p]) %>%
median_qi() %>%
mutate(year = years[nyears]+p)
ggplot(lka_q6, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_5, aes(year, .value)) +
geom_ribbon(data = res_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_5, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_5, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()+
labs(title = "Ratio of neonatal to other child mortality (logged), Sri Lanka",
y = "log ratio", subtitle = "RW2 fit shown in black")
vr_se_mean <- ika |> filter(source == "VR")$se
vr_se_mean <- ika |> filter(source == "VR") |> select(se)
vr_se_mean <- lka |> filter(source == "VR") |> select(se)
vr_se_mean <- mean(lka |> filter(source == "VR") |> select(se))
lka |> filter(source == "VR") |> select(se)
lka |>
mutate(if_vr = ifelse(source == "VR", "VR", "N_VR"))
lka |>
mutate(if_vr = ifelse(source == "VR", "VR", "N_VR")) |>
group_by(if_vr) |>
summarise(se_mean = mean(se))
lka |>
mutate(se_adjusted = ifelse(source == "VR", se*0.231/0.021), se)
lka |>
mutate(se_adjusted = ifelse(source == "VR", se*0.231/0.021, se))
lka_se_adj <- lka |>
mutate(se_adjusted = ifelse(source == "VR", se*0.231/0.021, se))
lka_se_adj <- lka |>
mutate(se_adjusted = ifelse(source == "VR", se*0.231/0.021, se))
observed_years <- lka_se_adj$year
years <- min(observed_years):max(observed_years)
nyears <- length(years)
stan_data <- list(y = lka_se_adj$logit_ratio, year_i = observed_years - years[1]+1,
T = nyears, years = years, N = length(observed_years),
mid_year = mean(years), se = lka_se_adj$se_adjusted, P = 9)
mod6_b <- stan(data = stan_data,
file = here("code/models/lab10_3.stan"),
iter = 2000)
ggplot(lka_q6, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_6, aes(year, .value)) +
geom_ribbon(data = res_6, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_6, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_6, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()+
labs(title = "Model 3, VR data only",
y = "log ratio", subtitle = "RW2 fit shown in black")
res_6_b <- mod6_b %>%
gather_draws(mu[t]) %>%
median_qi() %>%
mutate(year = years[t])
res_p_6_b <- mod6_b %>%
gather_draws(mu_p[p]) %>%
median_qi() %>%
mutate(year = years[nyears]+p)
ggplot(lka_se_adj, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_6_b, aes(year, .value)) +
geom_ribbon(data = res_6_b, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_6_b, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_6_b, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()+
labs(title = "Model 3, VR data only",
y = "log ratio", subtitle = "RW2 fit shown in black")
lka_q6 <- lka |>
filter(source == "VR")
observed_years <- lka_q6$year
years <- min(observed_years):max(observed_years)
nyears <- length(years)
stan_data <- list(y = lka_q6$logit_ratio, year_i = observed_years - years[1]+1,
T = nyears, years = years, N = length(observed_years),
mid_year = mean(years), se = lka_q6$se, P = 9)
res_6 <- mod6 %>%
gather_draws(mu[t]) %>%
median_qi() %>%
mutate(year = years[t])
res_p_6 <- mod6 %>%
gather_draws(mu_p[p]) %>%
median_qi() %>%
mutate(year = years[nyears]+p)
ggplot(lka_q6, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_6, aes(year, .value)) +
geom_ribbon(data = res_6, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_6, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_6, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()+
labs(title = "Model 3, VR data only",
y = "log ratio", subtitle = "RW2 fit shown in black")
lka |>
mutate(if_vr = ifelse(source == "VR", "VR", "N_VR")) |>
group_by(if_vr) |>
summarise(se_mean = mean(se))
lka_q6 <- lka |>
filter(source == "VR")
observed_years <- lka_q6$year
years <- min(observed_years):max(observed_years)
nyears <- length(years)
stan_data <- list(y = lka_q6$logit_ratio, year_i = observed_years - years[1]+1,
T = nyears, years = years, N = length(observed_years),
mid_year = mean(years), se = lka_q6$se*10, P = 9)
mod6 <- stan(data = stan_data,
file = here("code/models/lab10_3.stan"),
iter = 2000)
res_6 <- mod6 %>%
gather_draws(mu[t]) %>%
median_qi() %>%
mutate(year = years[t])
res_p_6 <- mod6 %>%
gather_draws(mu_p[p]) %>%
median_qi() %>%
mutate(year = years[nyears]+p)
ggplot(lka_q6, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_6, aes(year, .value)) +
geom_ribbon(data = res_6, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_6, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_6, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()+
labs(title = "Model 3, VR data only",
y = "log ratio", subtitle = "RW2 fit shown in black")
lka_q6 <- lka |>
filter(source == "VR")
observed_years <- lka_q6$year
years <- min(observed_years):max(observed_years)
nyears <- length(years)
stan_data <- list(y = lka_q6$logit_ratio, year_i = observed_years - years[1]+1,
T = nyears, years = years, N = length(observed_years),
mid_year = mean(years), se = lka_q6$se, P = 9)
mod6 <- stan(data = stan_data,
file = here("code/models/lab10_3.stan"),
iter = 2000)
res_6 <- mod6 %>%
gather_draws(mu[t]) %>%
median_qi() %>%
mutate(year = years[t])
res_p_6 <- mod6 %>%
gather_draws(mu_p[p]) %>%
median_qi() %>%
mutate(year = years[nyears]+p)
ggplot(lka_q6, aes(year, logit_ratio)) +
geom_point(aes( color = source)) +
geom_line(aes( color = source), lty = 2) +
geom_ribbon(aes(ymin = logit_ratio - se,
ymax = logit_ratio + se,
fill =  source), alpha = 0.1) +
theme_bw()+
geom_line(data = res_6, aes(year, .value)) +
geom_ribbon(data = res_6, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2)+
geom_line(data = res_p_6, aes(year, .value), col = "red") +
geom_ribbon(data = res_p_6, aes(y = .value, ymin = .lower, ymax = .upper), alpha = 0.2, fill = "red")+
theme_bw()+
labs(title = "Model 3, VR data only",
y = "log ratio", subtitle = "RW2 fit shown in black")
library(tidyverse)
library(here)
library(rstan)
library(tidybayes)
source(here("code/getsplines.R"))
d <- read_csv(here("data/fc_entries.csv"))
View(d)
getsplines <- function (x.i, # vector of years
I, # knot spacing
degree = 3)
{
x0 <- max(x.i) - 0.5 * I
knots <- seq(x0 - 1000 * I, x0 + 1000 * I, I)
while (min(x.i) < knots[1]) knots <- c(seq(knots[1] - 1000 *
I, knots[1] - I, I), knots)
while (max(x.i) > knots[length(knots)]) knots <- c(knots,
seq(knots[length(knots)] + I, knots[length(knots)] +
1000 * I, I))
Btemp.ik <- splines::bs(x.i, knots = knots[-c(1, length(knots))],
degree = degree, Boundary.knots = knots[c(1, length(knots))])
indicesofcolswithoutzeroes <- which(apply(Btemp.ik, 2, sum) >
0)
startnonzerocol <- indicesofcolswithoutzeroes[1]
endnonzerocol <- indicesofcolswithoutzeroes[length(indicesofcolswithoutzeroes)]
B.ik <- Btemp.ik[, startnonzerocol:endnonzerocol]
colnames(B.ik) <- paste0("spline", seq(1, dim(B.ik)[2]))
knots.k <- knots[startnonzerocol:endnonzerocol]
names(knots.k) <- paste0("spline", seq(1, dim(B.ik)[2]))
return(list(B.ik = B.ik, # the basis splines
knots.k = knots.k # knot placement
))
}
